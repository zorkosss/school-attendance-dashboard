<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Principal Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
    :root {
        --primary-color: #43a047;
        --primary-hover: #4caf50;
        --background-color: #eef5f0;
        --card-background: #ffffff;
        --text-color: #212121;
        --secondary-text: #5f6368;
        --border-color: #e0e0e0;
        --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
    body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--background-color); display: flex; flex-direction: column; min-height: 100vh; display: none; }
    .header { background-color: var(--primary-color); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .header-title { font-size: 1.4em; font-weight: 500; display: flex; align-items: center; gap: 10px; }
    .btn-logout { background: transparent; color: white; border: 1px solid #ffffff88; border-radius: 5px; padding: 8px 16px; cursor: pointer; transition: all 0.3s; }
    .btn-logout:hover { background-color: rgba(255,255,255,0.1); border-color: white; }
    .container { max-width: 1400px; width: 100%; margin: 30px auto; padding: 0 15px; box-sizing: border-box; flex: 1; }
    .tabs { border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
    .tab-btn { background: none; border: none; padding: 15px 20px; cursor: pointer; font-size: 1.1em; font-weight: 500; color: var(--secondary-text); border-bottom: 3px solid transparent; }
    .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; }
    .page-title { font-size: 1.8em; font-weight: 700; color: var(--text-color); }
    .btn-reset, .btn-export { background-color: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; white-space: nowrap; }
    .btn-reset:hover, .btn-export:hover { background-color: var(--primary-hover); }
    #absenceList { display: grid; gap: 25px; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); }
    .card { background-color: var(--card-background); border-radius: 8px; box-shadow: var(--shadow); overflow: hidden; }
    .card-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); font-size: 1.2em; font-weight: 700; background-color: #fafafa; display: flex; align-items: center; gap: 10px; }
    .card-body { padding: 20px; display: grid; gap: 12px; }
    .card-body p { margin: 0; display: flex; align-items: center; gap: 10px; color: var(--secondary-text); }
    .card-body i { color: var(--primary-color); width: 20px; text-align: center; }
    .card-footer { padding: 12px 20px; border-top: 1px solid var(--border-color); font-size: 0.85em; color: #777; background-color: #fafafa; }
    .analytics-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; align-items: start; }
    .chart-container, .top-absences-container { background-color: var(--card-background); padding: 25px; border-radius: 8px; box-shadow: var(--shadow); }
    .chart-container h3, .top-absences-container h3 { margin-top: 0; font-size: 1.3em; color: var(--text-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
    .chart-wrapper { position: relative; height: 40vh; }
    #topAbsencesList { list-style: none; padding: 0; }
    #topAbsencesList li { display: flex; justify-content: space-between; padding: 10px 5px; border-bottom: 1px solid #f0f0f0; }
    #topAbsencesList li:last-child { border-bottom: none; }
    .student-name { font-weight: 500; }
    .absence-count { font-weight: 700; color: var(--primary-color); }
    .footer { background-color: #e0e0e0; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; color: #555; font-size: 0.9em; border-top: 1px solid #ccc; }
    .footer .left-side { display: flex; align-items: center; gap: 10px; }
    .empty-state { text-align: center; padding: 60px; color: var(--secondary-text); grid-column: 1 / -1; background-color: var(--card-background); border-radius: 8px; box-shadow: var(--shadow); }
    .empty-state i { font-size: 3em; margin-bottom: 15px; color: #bdbdbd; }

    /* --- LOGO STYLES ARE NOW SEPARATE --- */
    .footer-logo-about, .footer-logo-rhti {
        cursor: pointer;
        height: 110px; /* Maintain aspect ratio */
        vertical-align: middle;
    }

    .footer-logo-about {
        width: 170px; /* You can edit the "About Us" logo size here */
    }

    .footer-logo-rhti {
        width: 170px; /* You can edit the "RHTI Logo" size here */
    }

    /* --- Responsive Design Media Queries --- */
    @media (max-width: 900px) { .analytics-grid { grid-template-columns: 1fr; } }
    @media (max-width: 768px) {
        #absenceList { grid-template-columns: 1fr; }
        .action-bar { flex-direction: column; align-items: flex-start; gap: 15px; }
        .footer { flex-direction: column; gap: 15px; text-align: center; }
        .footer .left-side { flex-direction: column; gap: 10px; }
        .page-title { font-size: 1.5em; }
    }
</style>
</head>
<body>
    <div class="header">
        <div class="header-title"><i class="fas fa-shield-halved"></i> Principal Dashboard</div>
        <button onclick="logout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <div class="container">
        <div class="action-bar">
            <h2 class="page-title">Absence Reports</h2>
            <button class="btn-reset" onclick="resetAbsences()"><i class="fas fa-undo"></i> Reset Today's Absences</button>
        </div>
        <div id="absenceList"></div>
        <div id="empty-state-container" style="display: none;">
             <div class="empty-state"><i class="fas fa-bell-slash"></i><p>No absence reports found for your divisions.</p></div>
        </div>
    </div>

    <div class="footer">
    <div class="left-side">
        <!-- Use the 'footer-logo-about' class for the first logo -->
        <img src="logo 1.png" alt="About Us" class="footer-logo-about" onclick="goAbout()">
        <span>Â© 2025 RHTI. All rights reserved. Made by Ziad</span>
    </div>
    <!-- Use the 'footer-logo-rhti' class for the second logo -->
    <img src="logo 2.png" alt="RHTI Logo" class="footer-logo-rhti">
</div>

    <script>
    // --- We are no longer using type="module" ---
    
    // --- Authentication is still handled by the browser ---
    const firebaseConfig = { apiKey: "AIzaSyBX3-pcg4gCUzHdPuRhP9BPTKbJr4zM2Mc", authDomain: "school-attendance-81385.firebaseapp.com", projectId: "school-attendance-81385", storageBucket: "school-attendance-81385.firebasestorage.app", messagingSenderId: "232756214397", appId: "1:232756214397:web:67de1961741864be744f14" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let principalDivisions = [];
    let allAbsences = [];

    auth.onAuthStateChanged(async (user) => {
        if (!user) { window.location.href = "principal_login.html"; return; }
        const principalDocRef = db.collection("principals").doc(user.uid);
        const principalDocSnap = await principalDocRef.get();

        if (!principalDocSnap.exists) {
            alert("Access Denied.");
            await auth.signOut();
            window.location.href = "principal_login.html";
            return;
        }
        principalDivisions = principalDocSnap.data().divisions || [];
        document.body.style.display = "flex";
        
        // --- Call the new function to fetch data from your server ---
        fetchAbsences();
    });

    // --- NEW: Function to get data from your backend ---
    async function fetchAbsences() {
        try {
            // Replace with your live Render URL
            const response = await fetch('https://ziad-school-app.onrender.com/absences');
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            
            const serverReports = await response.json();

            // The rest of the logic stays the same, it just uses the data from the server
            allAbsences = serverReports
                .map(report => ({
                    ...report,
                    timestamp: new Date(report.timestamp) // Convert string back to Date object
                }))
                .filter(report => principalDivisions.includes(report.division));

            const activeAbsences = allAbsences.filter(report => report.status !== 'archived');
            
            const reportsContainer = document.getElementById("absenceList");
            const emptyStateContainer = document.getElementById("empty-state-container");
            reportsContainer.innerHTML = '';
            
            if (activeAbsences.length > 0) {
                emptyStateContainer.style.display = 'none';
                activeAbsences.forEach(reportData => {
                    const card = document.createElement("div");
                    card.className = "card";
                    card.id = `card-${reportData.id}`;
                    const formattedTime = reportData.timestamp.toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    card.innerHTML = `...`; // Your card HTML
                    reportsContainer.appendChild(card);
                });
            } else {
                emptyStateContainer.style.display = 'block';
            }
            
            updateAnalytics();

        } catch (error) {
            console.error("Failed to fetch absences:", error);
            document.getElementById("absenceList").innerHTML = "<p>Error loading data. Please try again later.</p>";
        }
    }

    // --- IMPORTANT: The Reset/Archive button can no longer work from the browser ---
    // because the browser doesn't have permission to write to the database anymore.
    // This is a feature that would need its own backend endpoint.
    window.resetAbsences = function() {
        alert("This feature is now managed by the automated daily reset on the server.");
    }
    
    // The rest of the functions are unchanged
    let trendChartInstance = null;
    function updateAnalytics() { /* ... unchanged ... */ }
    window.openTab = function(tabName) { /* ... unchanged ... */ }
    window.exportToCSV = function() { /* ... unchanged ... */ }
    window.logout = async function() { await auth.signOut(); window.location.href = "principal_login.html"; }
    window.goAbout = function() { window.open("about_us.html", "_blank"); }
</script>

<!-- Add these Firebase compat scripts to your <head> if they aren't there already -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</body>
</html>
