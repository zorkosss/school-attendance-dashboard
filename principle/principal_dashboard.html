<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Principal Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
:root {
    --primary-color: #007bff;
    --primary-hover: #0056b3;
    --background-color: #f8f9fa;
    --card-background: #ffffff;
    --text-color: #343a40;
    --secondary-text: #6c757d;
    --shadow-elevation: 0 4px 12px rgba(0,0,0,0.08);
    --border-radius-lg: 10px;
}
body { font-family:'Montserrat',sans-serif; padding:0; margin:0; background:var(--background-color); color:var(--text-color); min-height:100vh; display:none;}
.container { max-width:1300px; margin:0 auto; padding:25px; }
.header { display:flex; justify-content:space-between; align-items:center; background:var(--primary-color); padding:18px 30px; color:white; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:25px;}
.header h2{margin:0;font-weight:600;}
#welcome{font-size:1.2em;font-weight:500;color:var(--primary-color);margin-bottom:15px;padding-left:5px;}
.dashboard-title{font-weight:700;font-size:1.8em;margin-bottom:20px;border-bottom:3px solid #dee2e6;padding-bottom:10px;color:var(--text-color);}
#absenceList{display:grid;gap:20px;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));}
.card{background:var(--card-background);padding:20px;border-radius:var(--border-radius-lg);box-shadow:var(--shadow-elevation);transition:transform 0.2s;border-left:5px solid var(--primary-color);}
.card:hover{transform:translateY(-3px);box-shadow:0 8px 15px rgba(0,0,0,0.12);}
.card h3{color:var(--primary-color);margin-top:0;margin-bottom:10px;font-weight:600;font-size:1.3em;}
.card p{margin:8px 0;font-size:0.95em;}
.card strong{font-weight:600;}
.card small{display:block;margin-top:10px;color:var(--secondary-text);font-size:0.8em;border-top:1px solid #eee;padding-top:5px;}
.btn-logout{background:none;color:white;border:1px solid white;padding:8px 15px;border-radius:5px;cursor:pointer;font-size:14px;transition:background 0.3s;}
.btn-logout:hover{background:rgba(255,255,255,0.15);}
.reset-btn{margin-top:20px;padding:10px 15px;background:var(--primary-color);color:white;border:none;border-radius:5px;cursor:pointer;font-weight:600;}
.reset-btn:hover{background:var(--primary-hover);}
.footer-left { position: fixed; bottom: 10px; left: 10px; cursor:pointer; color: var(--primary-color); font-weight: 600; }
.footer-right { position: fixed; bottom: 10px; right: 10px; color: var(--secondary-text); font-size:14px;}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, onSnapshot, query, orderBy, where, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBX3-pcg4gCUzHdPuRhP9BPTKbJr4zM2Mc",
    authDomain: "school-attendance-81385.firebaseapp.com",
    projectId: "school-attendance-81385",
    storageBucket: "school-attendance-81385.firebasestorage.app",
    messagingSenderId: "232756214397",
    appId: "1:232756214397:web:67de1961741864be744f14"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let principalDivisions = []; // This global variable will hold the principal's allowed divisions

onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "principal_login.html";
        return;
    }

    // --- ROLE VERIFICATION ---
    // Check if the logged-in user's email exists in the 'principals' collection
    const principalsQuery = query(collection(db, "principals"), where("email", "==", user.email));
    const principalsSnap = await getDocs(principalsQuery);

    if (principalsSnap.empty) {
        // If the query is empty, this user is NOT a principal.
        alert("Access Denied: You are not authorized to view this page.");
        await signOut(auth); // Log them out
        window.location.href = "principal_login.html"; // Redirect them
        return;
    }

    // --- FETCH DIVISIONS ---
    // If the check passes, get the divisions from their document
    principalsSnap.forEach(docSnap => {
        principalDivisions = docSnap.data().divisions || [];
    });

    document.body.style.display = "block";
    const principalName = user.email.split('@')[0];
    document.getElementById("welcome").innerHTML = `<i class="fas fa-handshake"></i> Welcome, <b>${principalName}</b>. Here are the latest absence reports.`;

    listenForAbsences(); // Now that we have the divisions, start listening for reports
});

function listenForAbsences() {
    const q = query(collection(db, "absences"), orderBy("timestamp", "desc"));
    onSnapshot(q, snapshot => {
        const container = document.getElementById("absenceList");
        container.innerHTML = "";
        let reportsFound = false;

        snapshot.forEach(doc => {
            const data = doc.data();
            
            // --- FILTERING LOGIC ---
            // Only show the report if its division is in the principal's list of allowed divisions
            if (principalDivisions.includes(data.division)) {
                reportsFound = true;
                const card = document.createElement("div");
                card.className = "card";
                const formattedTime = data.timestamp ? data.timestamp.toDate().toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
                card.innerHTML = `
                    <h3><i class="fas fa-school"></i> ${data.class}</h3>
                    <p><strong><i class="fas fa-user-tie"></i> Teacher:</strong> ${data.teacher}</p>
                    <p><strong><i class="fas fa-user-times"></i> Absentees:</strong> ${data.absentees}</p>
                    <p><strong>Division:</strong> ${data.division}</p>
                    <small><i class="fas fa-clock"></i> Reported On: ${formattedTime}</small>
                `;
                container.appendChild(card);
            }
        });

        if (!reportsFound) {
            container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--secondary-text);"><i class="fas fa-bell-slash" style="font-size:2em;margin-bottom:10px;"></i><p>No absence reports submitted yet for your divisions.</p></div>`;
        }
    });
}

window.logout = async function() {
    await signOut(auth);
    window.location.href = "principal_login.html";
}

window.resetAbsences = async function() {
    if (!confirm("Are you sure you want to reset today's absences?")) return;
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const snapshot = await getDocs(collection(db, "absences"));
    let deletedCount = 0;
    snapshot.forEach(async docSnap => {
        const data = docSnap.data();
        if (principalDivisions.includes(data.division) && data.timestamp && data.timestamp.toDate() >= today) {
            await deleteDoc(doc(db, "absences", docSnap.id));
            deletedCount++;
        }
    });
    alert(`${deletedCount} of today's absences have been reset âœ…`);
}

window.goAbout = function() {
    window.open("about_us.html", "_blank");
}
</script>
</head>
<body>
<div class="header">
    <h2><i class="fas fa-tachometer-alt"></i> Principal Dashboard</h2>
    <button onclick="logout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
</div>

<div class="container">
    <div id="welcome">Loading...</div>
    <div class="dashboard-title">Absence Reports</div>
    <div id="absenceList"><p>Verifying access and loading reports...</p></div>
    <button class="reset-btn" onclick="resetAbsences()">Reset Today's Absences</button>
</div>

<div class="footer-left" onclick="goAbout()"><i class="fas fa-school"></i> About Us</div>
<div class="footer-right">Made by Ziad</div>
</body>
</html>
