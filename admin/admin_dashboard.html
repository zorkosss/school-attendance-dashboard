<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #c0392b; /* Authoritative Red */
            --primary-hover: #e74c3c;
            --background-color: #f1f2f6;
            --card-background: #ffffff;
            --text-color: #2c3e50;
            --border-color: #e0e0e0;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--background-color); min-height: 100vh; display: none; }
        .header { background-color: var(--primary-color); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-title { font-size: 1.4em; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .btn-logout { background: transparent; color: white; border: 1px solid #ffffff88; border-radius: 5px; padding: 8px 16px; cursor: pointer; transition: all 0.3s; }
        .btn-logout:hover { background-color: rgba(255,255,255,0.2); border-color: white; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 15px; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .management-card { background-color: var(--card-background); border-radius: 8px; box-shadow: var(--shadow); padding: 25px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .card-header h2 { margin: 0; font-size: 1.5em; color: var(--text-color); }
        .btn-add { background-color: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        .btn-add:hover { background-color: #2ecc71; }
        .user-list { list-style: none; padding: 0; margin: 0; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .user-item:last-child { border-bottom: none; }
        .user-details { flex-grow: 1; word-break: break-all; }
        .user-email { color: #333; font-weight: 500; }
        .user-divisions { font-size: 0.9em; color: #777; margin-left: 15px; }
        .user-actions { display: flex; gap: 10px; }
        .btn-edit, .btn-reset-pass { background-color: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .btn-edit:hover, .btn-reset-pass:hover { background-color: #2980b9; }
        .btn-delete { background-color: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .btn-delete:hover { background-color: #c0392b; }
        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 10px; padding: 15px; }
            .container { margin-top: 20px; }
            .card-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .user-item { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updatePassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, deleteDoc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBX3-pcg4gCUzHdPuRhP9BPTKbJr4zM2Mc", authDomain: "school-attendance-81385.firebaseapp.com", projectId: "school-attendance-81385", storageBucket: "school-attendance-81385.firebasestorage.app", messagingSenderId: "232756214397", appId: "1:232756214397:web:67de1961741864be744f14" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = "admin_login.html"; return; }
            const adminDocRef = doc(db, "admins", user.uid);
            const adminDocSnap = await getDoc(adminDocRef);
            if (!adminDocSnap.exists()) {
                alert("ACCESS DENIED. You are not an administrator.");
                await signOut(auth);
                window.location.href = "index.html";
                return;
            }
            document.body.style.display = "block";
            fetchAndDisplayUsers();
        });
        
        async function createUser(email, password, roleData, collectionName) {
            const tempAppName = 'temp-user-creation-app-' + Date.now();
            const tempApp = initializeApp(firebaseConfig, tempAppName);
            const tempAuth = getAuth(tempApp);
            try {
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, collectionName, user.uid), roleData);
                alert(`SUCCESS!\nUser ${email} has been created successfully.`);
            } catch (error) {
                alert(`Error creating user: ${error.message}`);
            } finally {
                await deleteApp(tempApp);
            }
        }
        
        async function addPrincipal() {
            const email = prompt("Enter the new principal's email:");
            if (!email) return;
            const password = prompt("Enter a password for the new principal (at least 6 characters):");
            if (!password || password.length < 6) { alert("Password must be at least 6 characters. User creation cancelled."); return; }
            const divisionsStr = prompt("Enter divisions, separated by commas (e.g., Kindergarten,Elementary):");
            if (divisionsStr === null) return;
            const divisions = divisionsStr.split(',').map(d => d.trim()).filter(d => d);
            const roleData = { email, divisions };
            await createUser(email, password, roleData, 'principals');
        };

        async function addTeacher() {
            const email = prompt("Enter the new teacher's email:");
            if (!email) return;
            const password = prompt("Enter a password for the new teacher (at least 6 characters):");
            if (!password || password.length < 6) { alert("Password must be at least 6 characters. User creation cancelled."); return; }
            const roleData = { email };
            await createUser(email, password, roleData, 'teachers');
        };
        
        window.editPrincipalDivisions = async function(docId, currentDivisions) {
            const newDivisionsStr = prompt("Edit the principal's divisions (comma-separated):", currentDivisions);
            if (newDivisionsStr === null || newDivisionsStr === currentDivisions) return;
            const newDivisions = newDivisionsStr.split(',').map(d => d.trim()).filter(d => d);
            try {
                await updateDoc(doc(db, "principals", docId), { divisions: newDivisions });
                alert("Principal's divisions updated successfully.");
            } catch (error) {
                alert("Error updating divisions: " + error.message);
            }
        };

        window.setNewPassword = async function(email) {
            if (!confirm(`Are you sure you want to set a new password for ${email}?`)) return;
            
            const oldPassword = prompt("To re-authenticate, please enter YOUR (the admin's) current password:");
            if (!oldPassword) return;

            const newPassword = prompt("Enter the NEW password for the user (at least 6 characters):");
            if (!newPassword || newPassword.length < 6) {
                alert("Invalid new password. Operation cancelled.");
                return;
            }

            // Create a temporary app to sign in as the target user without signing the admin out
            const tempAppName = 'temp-password-reset-app-' + Date.now();
            const tempApp = initializeApp(firebaseConfig, tempAppName);
            const tempAuth = getAuth(tempApp);

            try {
                // This is a workaround: we need the user's current password to sign them in.
                // Since the admin doesn't know it, this part is tricky.
                // A secure Cloud Function is the only way to bypass this.
                // For a client-side solution, sending a reset email is the most secure option.
                // This function demonstrates the concept but highlights the security limitations.
                alert("For security, direct password setting requires a Cloud Function (paid plan). The recommended secure action is to send a password reset email instead.");
                
                // We will proceed with the 'send reset email' function as the secure, free alternative.
                await sendPasswordResetEmail(auth, email);
                alert(`A password reset email has been sent to ${email} as the secure alternative.`);

            } catch (error) {
                alert(`An error occurred: ${error.message}. Please use the password reset email function.`);
            } finally {
                await deleteApp(tempApp);
            }
        };

        window.deleteUser = async function(collectionName, docId) {
            if (!confirm("Are you sure you want to delete this user's role and login? This is NOT reversible.")) return;
            await deleteDoc(doc(db, collectionName, docId));
            alert("User role deleted from the database. IMPORTANT: You must still go to Firebase Authentication to manually delete their login account.");
        };

        window.logout = async function() { await signOut(auth); window.location.href = "admin_login.html"; };
        
        function fetchAndDisplayUsers() {
            onSnapshot(collection(db, "principals"), (snapshot) => {
                const list = document.getElementById('principals-list');
                list.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const item = document.createElement('li');
                    item.className = 'user-item';
                    item.innerHTML = `
                        <div class="user-details">
                            <span class="user-email">${data.email}</span>
                            <span class="user-divisions">Divisions: ${data.divisions.join(', ')}</span>
                        </div>
                        <div class="user-actions">
                            <button title="Edit Divisions" class="btn-edit" onclick="editPrincipalDivisions('${docSnap.id}', '${data.divisions.join(', ')}')"><i class="fas fa-pencil-alt"></i></button>
                            <button title="Set New Password" class="btn-reset-pass" onclick="setNewPassword('${data.email}')"><i class="fas fa-key"></i></button>
                            <button title="Delete User" class="btn-delete" onclick="deleteUser('principals', '${docSnap.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });

            onSnapshot(collection(db, "teachers"), (snapshot) => {
                const list = document.getElementById('teachers-list');
                list.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const item = document.createElement('li');
                    item.className = 'user-item';
                    item.innerHTML = `
                        <div class="user-details">
                            <span class="user-email">${data.email}</span>
                        </div>
                        <div class="user-actions">
                             <button title="Set New Password" class="btn-reset-pass" onclick="setNewPassword('${data.email}')"><i class="fas fa-key"></i></button>
                             <button title="Delete User" class="btn-delete" onclick="deleteUser('teachers', '${docSnap.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });
        }
        
        document.getElementById('add-principal-btn').addEventListener('click', addPrincipal);
        document.getElementById('add-teacher-btn').addEventListener('click', addTeacher);
    </script>
</head>
<body>
    <div class="header">
        <div class="header-title"><i class="fas fa-user-shield"></i> Admin Dashboard</div>
        <button onclick="logout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
    <div class="container">
        <div class="dashboard">
            <div class="management-card">
                <div class="card-header">
                    <h2>Manage Principals</h2>
                    <button id="add-principal-btn" class="btn-add"><i class="fas fa-plus"></i> Add Principal</button>
                </div>
                <ul id="principals-list" class="user-list"></ul>
            </div>
            <div class="management-card">
                <div class="card-header">
                    <h2>Manage Teachers</h2>
                    <button id="add-teacher-btn" class="btn-add"><i class="fas fa-plus"></i> Add Teacher</button>
                </div>
                <ul id="teachers-list" class="user-list"></ul>
            </div>
        </div>
    </div>
</body>
</html>
